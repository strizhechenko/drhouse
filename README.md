# Design Notes

## Устройство тестов

В тесте определяются функции (обязательно только check):

- check - возвращает код возврата, 0 - нет проблемы, любой другой - есть
- fix - попытка исправить проблему не рестартуя app
- fix_ok - вывод сообщения о том что всё ок
- error - вывод сообщения об ошибке

В конце вызывается слелующая конструкция:

. /usr/local/lib/drhouse drhouse_main - если провал теста после починки должен уводить app в safemode
. /usr/local/lib/drhouse drhouse_main_nosafemode - чтобы тест просто пытался починить проблему, не выйдет - и ладно

## Логика drhouse

1. Запускаем проверку (check)
2. Если она не нашла проблемы - exit 0, завершаемся
3. Если проблема есть, выводим сообщение об ошибке
4. Запускаем исправление (fix), по умолчанию - просто return 1
5. Если не удалось - drhouse_main приведёт app к safemode, drhouse_main_nosafemode - просто завершится с ошибкой
6. Если оно удалось - хорошо, можно что-нибудь написать определив функцию fix_ok
7. Снова запускаем проверку
8. Если проблемы нет, exit 0, завершаемся
9. Если проблема не пропала, т.е. fix не помог - drhouse_main даст safemode, drhouse_main_nosafemode - ошибку

В случае если тест вернёт неважно какую ошибку - администратору будет отправлено об этом сообщение через систему alarm.

## Соглашения

- Safemode стоит использовать только в крайних случаях: если кончилось место или дальнейшая работа app опасна для него
- Новые тесты стоит создавать скопировав файл check_template.sh из этого репозитория.
